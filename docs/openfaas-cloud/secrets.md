OpenFaaS Cloud **secret** objects lets you store and manage sensitive information securely


## Using secrets

Secrets in OpenFaaS Cloud will be mounted as data volumes and made accessible to your function

### Creating secrets

To consume a **secret** in a function:

1.\ Create the secret object `secret.yml` using literals or from a file

`faas-cli cloud seal --cert pub.cert --name {username}-database-creds --literal username=admin --literal password=1234`

|                   |                         |
|-------------------|-------------------------|
| --name       | The name of the secret object prefixed with your GitHub username |
| --cert       | The OpenFaaS cloud [public key](https://github.com/openfaas/cloud-functions/blob/master/pub-cert.pem). Please download to a local file |
| --literal    | Secret key and value pair. You can specify this parameter more than once to add more secrets |
| --from-file  | Read secret from file. **Note** secret key name will be the filename. At the moment we do not support specifying the key name when creating a secret from a file. |


2.\ Update your function to include the secret in your `stack.yml`

```yaml
  my-function:   
    secrets:
      - database-creds
```

> **Note:** GitHub `{username}` prefix is removed in the `stack.yml`


3.\ Update you function code to read the secret from `/var/openfaas/secrets/{key}`

Where `{key}` is the name of the key pair. From our example in step 1 `username` or `password`:

- `/var/openfaas/secrets/username`
- `/var/openfaas/secrets/password` 

4.\ Commit `secret.yml` and other modified files. **Note** `secret.yml` must be in the root of your GitHub repository

## Example-walk-through

[Reference repository](https://github.com/alexellis/my-fn)

In this example we'll encrypt an incoming webhook URL for Slack, which should be considered as confidential information.

Let's write the example function:

```yaml
def handle(req):
    webhook_url = None
    with open("/var/openfaas/secrets/incoming-webhook-url") as webhook_url_text:
        webhook_url = webhook_url_text.read().strip()

    respond_to_user(req, webhook_url)
```
*handler.py*

We see that the secret is read as per any other OpenFaaS secret, from the mounted location on disk at: `/var/openfaas/secrets/`.

Now let's look at how we seal the secret:

```sh
# Seal secrets for owner alexellis named `fn-secrets`

faas-cli cloud seal --name alexellis-fn-secrets --literal incoming-webhook-url=https://...
```

Here's the file generated by the command above:

```yaml
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: alexellis-fn-secrets
  namespace: openfaas-fn
spec:
  encryptedData:
    incoming-webhook-url: (redacted)
```
*secrets.yaml*

And finally, we now need to reference the name of our secret in `stack.yml`. Notice that the key and the secret name do not have to match, this is because we can have multiple secret key/values within a single secret.

```yaml
provider:
  name: faas
  gateway: http://127.0.0.1:8080

functions:
  slack-me:
    lang: python
    handler: ./slack-me
    image: alexellis/slack-me
    secrets:
      - fn-secrets
```
*stack.yml*

#### Troubleshooting

The steps above must be followed precisely and if you have mis-read any of the details this may result in the secret not being accessible.

Notes:

* When using `kubeseal` your secret name needs to be prefixed with your username i.e. `alexellis-my-secret`
* Each `--literal` must have no prefix, it's the exact name you will use in `stack.yml`
* In `stack.yml` your secrets should have no prefix, this is added later automatically
* You must commit `secrets.yaml` into your repo and do a `git push`

If in doubt check your results against [this reference repository](https://github.com/alexellis/my-fn).

